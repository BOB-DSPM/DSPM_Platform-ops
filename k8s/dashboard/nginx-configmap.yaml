apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-nginx-config
  namespace: dspm
data:
  default.conf: |
    server {
        listen 80;

        # Backend API 프록시 - /api/ 제거하고 직접 전달
        location /api/ {
            proxy_pass http://dspm-backend:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # CORS 헤더
            add_header Access-Control-Allow-Origin $scheme://$host;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
            
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $scheme://$host;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
                return 204;
            }
        }

        # Backend Health Check 직접 접근 허용
        location /health {
            proxy_pass http://dspm-backend:8080/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Analyzer 직접 접근 완전 차단
        location ~ ^/(analyzer|internal) {
            return 403 "Direct access denied";
        }

        location /dashboard {
            alias /usr/share/nginx/html;
            try_files $uri $uri/ /dashboard/index.html;
            index index.html;
        }

        location /dashboard/static {
            alias /usr/share/nginx/html/static;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }
        
        # 기본 경로는 dashboard로 리다이렉트 (health 제외)
        location = / {
            return 301 /dashboard/;
        }
    }